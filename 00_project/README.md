# Проектная работа

Веб проект с развертыванием нескольких виртуальных машин должен отвечать следующим требованиям:

- включен https;
- основная инфраструктура в DMZ зоне;
- файрволл на входе;
- сбор метрик и настроенный алертинг;
- везде включен selinux;
- организован централизованный сбор логов;
- организован backup.

## Настройка гипервизора
В качестве гипервизора виртуальных машин будем использовать Proxmox Virtual Environment

Для обеспечения возможности управлять гипервизором с инженерной станции создадим пользователя ansible на Proxmox и настроим SSH-доступ с возможностью выполнения команд от root (через sudo)

На proxmox сохдадим пользователя
```sh
adduser ansible
```

На инженерной станции (откуда будем подключаться) создадим ssh ключ
```
ssh-keygen -t ed25519 -C "ansible@eng"
```
Вручную добавим ключ на сервер Proxmox в ~/.ssh/authorized_keys:
```sh
mkdir -p /home/ansible/.ssh
echo "публичный_ключ" >> /home/ansible/.ssh/authorized_keys
chown -R ansible:ansible /home/ansible/.ssh
chmod 700 /home/ansible/.ssh
chmod 600 /home/ansible/.ssh/authorized_keys
```
Дадим пользователю права на выполнение любых команд от root без ввода пароля:
```sh
echo "ansible ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/ansible
sudo chmod 440 /etc/sudoers.d/ansible
```

Для работы будем использовать три сети
- внешняя сеть proxmox куда будет смотреть веб сервер (80,443 порты)
- NAT сеть с помощью которой машины будут выходить в интернет, она же будет внутренняя сеть для обмена между вм и работы с инженерной станцией (192.168.90.0/28 - сеть на 14 хостов)

После добавления ВМ нужно перед запуском пройти в Datacenter/SDN/IPAM и выставить нужный адрес машине.

Для NAT сети будем использовать встроенный функционал Proxmox Software-Defined Network (SDN)
Чтобы proxmox мог задействовать встроенный функционал DHCP IPAM (IP Address Management) необходиомо установить дополниетльные пакеты (`dnsmasq`) на гипервизор и отключить конфигурацию по умолчанию.

```sh
apt update
apt install dnsmasq
# disable default instance
systemctl disable --now dnsmasq
```

Теперь можно идти в GUI Proxmox, в раздел Datacenter ⇨ SDN ⇨ Zones. Добавляем новую зону типа Simple. Идём в Vnets, добавляем новую сеть, например vm. Имя этой сети будет задавать имя сетевого бриджа, который будет создан в системе. Выбираем созданную сеть и добавляем к ней подсеть. Например, 10.200.0.0/24, шлюз 10.200.0.1, в SNAT ставим галочку. Во вкладке DHCP Ranges указываете диапазон IP адресов, которые будут назначаться виртуалкам с этой сетью.

1. Создаем зону simple с названием `vm`
2. Идем в `VNets` и создаем виртуальную сеть с названием `vmnet` в зоне `vm`
3. Выбираем созданную сеть и добавляем к нец подсеть 10.100.0.0/24, шлюз 10.100.0.1, в SNAT ставим галочку Также настраиваем dhcp range.

Когда внесёте все настройки, возвращайтесь в раздел SDN и нажимайте на кнопку Apply, чтобы изменения применились.

В качестве операционной системы для проекта выберем Debian 12. Проведем установку Debian на вновь созданную виртуальную машину и сделаем ее щаблоном, чтобы с помощью копирования быстро содать необходимое количество ВМ.

Создадим необходимые ВМ с соответствующим функционалом а также присвоим им фиксированные ip адреса во внутренней сети:
- web-proxy (angie)
- web-01 (app)
- db-01 (master)
- db-02 (replica)
- log-srv
- backup-srv
- monitoring-srv
